<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ–Ω–Ω–∏—Å–Ω–∞—è –ª–∏–≥–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å—Ç–∞–≤–æ–∫</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 5px; cursor: pointer; flex: 1; text-align: center; }
        .tab.active { background: #667eea; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 10px; }
        .tab-content.active { display: block; }
        .tournament-card, .bet-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .match-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .bet-form { display: flex; gap: 10px; margin-top: 10px; }
        .bet-form input { flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .bet-form button { padding: 5px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 5px; color: white; z-index: 1000; }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #f44336; }
        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéæ –¢–µ–Ω–Ω–∏—Å–Ω–∞—è –ª–∏–≥–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π —Å—Ç–∞–≤–æ–∫</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–≤ –∏ —Å—Ç–∞–≤–æ–∫</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab('tournaments')">üèÜ –¢—É—Ä–Ω–∏—Ä—ã</button>
            <button class="tab" onclick="openTab('bets')">üéØ –°—Ç–∞–≤–∫–∏</button>
            <button class="tab" onclick="openTab('integration')">üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</button>
        </div>
        
        <div id="tournaments" class="tab-content active">
            <h2>–¢–µ–∫—É—â–∏–π —Ç—É—Ä–Ω–∏—Ä</h2>
            <div id="currentTournament"></div>
            
            <h2>–°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä</h2>
            <div class="tournament-card">
                <input type="text" id="tournamentName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                <select id="tournamentType" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                    <option value="round_robin_3">–ö—Ä—É–≥–æ–≤–æ–π —Ç—É—Ä–Ω–∏—Ä (3 –∏–≥—Ä–æ–∫–∞)</option>
                    <option value="round_robin_4">–ö—Ä—É–≥–æ–≤–æ–π —Ç—É—Ä–Ω–∏—Ä (4 –∏–≥—Ä–æ–∫–∞)</option>
                    <option value="round_robin_5">–ö—Ä—É–≥–æ–≤–æ–π —Ç—É—Ä–Ω–∏—Ä (5 –∏–≥—Ä–æ–∫–æ–≤)</option>
                </select>
                <div id="playerSelection" style="margin-bottom: 10px;">
                    <label><input type="checkbox" value="–ò–≥—Ä–æ–∫ 1"> –ò–≥—Ä–æ–∫ 1 (1000)</label><br>
                    <label><input type="checkbox" value="–ò–≥—Ä–æ–∫ 2"> –ò–≥—Ä–æ–∫ 2 (950)</label><br>
                    <label><input type="checkbox" value="–ò–≥—Ä–æ–∫ 3"> –ò–≥—Ä–æ–∫ 3 (1100)</label><br>
                    <label><input type="checkbox" value="–ò–≥—Ä–æ–∫ 4"> –ò–≥—Ä–æ–∫ 4 (1050)</label><br>
                    <label><input type="checkbox" value="–ò–≥—Ä–æ–∫ 5"> –ò–≥—Ä–æ–∫ 5 (980)</label>
                </div>
                <button onclick="createTournament()" style="width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    üèÜ –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
                </button>
            </div>
        </div>
        
        <div id="bets" class="tab-content">
            <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏</h2>
            <div id="activeBets"></div>
            
            <h2>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</h2>
            <div id="betHistory"></div>
        </div>
        
        <div id="integration" class="tab-content">
            <h2>üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</h2>
            <div class="tournament-card">
                <h3>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h3>
                <p>1. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—É—Ä–Ω–∏—Ä –≤ —Å–∏—Å—Ç–µ–º–µ —Ä–µ–π—Ç–∏–Ω–≥–∞</p>
                <p>2. <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –º–∞—Ç—á–∏ –¥–ª—è —Å—Ç–∞–≤–æ–∫</strong></p>
                <p>3. –ò–≥—Ä–æ–∫–∏ –¥–µ–ª–∞—é—Ç —Å—Ç–∞–≤–∫–∏ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –º–∞—Ç—á–∏</p>
                <p>4. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞—Ç—á–∞ <strong>–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å—Ç–∞–≤–∫–∏</strong></p>
                <p>5. –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∂–µ—Ç–æ–Ω—ã</p>
                
                <div style="margin: 20px 0; padding: 15px; background: #e8f5e9; border-radius: 5px;">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h3>
                    <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ —Å—Ç–∞–≤–æ–∫: <span id="autoBetsCount">0</span></p>
                    <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ: <span id="autoCalculated">0</span></p>
                    <p>–û–±—â–∞—è —Å—É–º–º–∞ –∂–µ—Ç–æ–Ω–æ–≤ –≤ –æ–±–æ—Ä–æ—Ç–µ: <span id="totalTokens">0</span></p>
                </div>
                
                <button onclick="runAutoIntegration()" style="width: 100%; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                    üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
                </button>
            </div>
        </div>
    </div>

<script>
// ============================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================
const SUPABASE_URL = 'https://bqycjfcjtdawyrysgrbw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxeWNqZmNqdGRhd3lyeXNncmJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDE5NzAsImV4cCI6MjA4MjE3Nzk3MH0.LEOUMFAd1cz_1e4uawJcaZLPCMqAQHEWM52Oy7fDjsE';

let supabase = null;
let currentTournament = null;
let allPlayers = [];
let tournamentMatches = [];
let allBets = [];
let playerCabinets = [];

// ============================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    await loadAllData();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    updateTournamentDisplay();
    updateBetsDisplay();
    
    console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
});

// ============================================
// –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–•
// ============================================
async function loadAllData() {
    try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...');
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        const { data: playersData } = await supabase
            .from('players')
            .select('*')
            .order('rating', { ascending: false });
        
        allPlayers = playersData || [];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞
        const { data: tournamentsData } = await supabase
            .from('tournaments')
            .select('*')
            .eq('status', 'active')
            .order('created_at', { ascending: false })
            .limit(1);
        
        if (tournamentsData && tournamentsData.length > 0) {
            currentTournament = tournamentsData[0];
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π —Ç—É—Ä–Ω–∏—Ä–∞
            const { data: matchesData } = await supabase
                .from('tournament_matches')
                .select('*')
                .eq('tournament_id', currentTournament.id);
            
            tournamentMatches = matchesData || [];
            
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω —Ç—É—Ä–Ω–∏—Ä: ${currentTournament.name} —Å ${tournamentMatches.length} –º–∞—Ç—á–∞–º–∏`);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º —Å—Ç–∞–≤–∫–∏ –¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π
            await autoCreateBetsForTournament();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–≤–æ–∫
        const { data: betsData } = await supabase
            .from('player_bets')
            .select('*')
            .order('created_at', { ascending: false });
        
        allBets = betsData || [];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
        const { data: cabinetsData } = await supabase
            .from('player_cabinets')
            .select('*');
        
        playerCabinets = cabinetsData || [];
        
        console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
}

// ============================================
// –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–û–ó–î–ê–ù–ò–ï –°–¢–ê–í–û–ö –î–õ–Ø –¢–£–†–ù–ò–†–ê
// ============================================
async function autoCreateBetsForTournament() {
    if (!currentTournament || !tournamentMatches.length) return;
    
    try {
        console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞–≤–æ–∫ –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–∞ "${currentTournament.name}"`);
        
        // –ù–∞—Ö–æ–¥–∏–º –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –º–∞—Ç—á–∏
        const pendingMatches = tournamentMatches.filter(match => 
            !match.winner && match.status !== 'finished'
        );
        
        if (pendingMatches.length === 0) {
            console.log('‚úÖ –í—Å–µ –º–∞—Ç—á–∏ —Ç—É—Ä–Ω–∏—Ä–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã');
            return;
        }
        
        let createdBetsCount = 0;
        
        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ –º–∞—Ç—á–∞
        for (const match of pendingMatches) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –º–∞—Ç—á
            const existingBets = allBets.filter(bet => 
                bet.match_id === match.id && bet.status === 'active'
            );
            
            if (existingBets.length === 0) {
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—á –¥–ª—è —Å—Ç–∞–≤–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ bet_matches
                await createBetMatchFromTournamentMatch(match);
                createdBetsCount++;
            }
        }
        
        if (createdBetsCount > 0) {
            console.log(`‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ —Å—Ç–∞–≤–æ–∫ –¥–ª—è ${createdBetsCount} –º–∞—Ç—á–µ–π`);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–æ–∫
            await loadAllData();
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞–≤–æ–∫:', error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞ –¥–ª—è —Å—Ç–∞–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–≥–æ –º–∞—Ç—á–∞
async function createBetMatchFromTournamentMatch(tournamentMatch) {
    try {
        // –ù–∞—Ö–æ–¥–∏–º –∏–≥—Ä–æ–∫–æ–≤
        const player1 = allPlayers.find(p => p.name === tournamentMatch.player1);
        const player2 = allPlayers.find(p => p.name === tournamentMatch.player2);
        
        if (!player1 || !player2) {
            console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –æ–¥–∏–Ω –∏–∑ –∏–≥—Ä–æ–∫–æ–≤:', tournamentMatch.player1, tournamentMatch.player2);
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –º–∞—Ç—á–∞ —Å—Ç–∞–≤–æ–∫
        const betMatchId = `bet_${tournamentMatch.id}`;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
        const rating1 = player1.rating || 1000;
        const rating2 = player2.rating || 1000;
        const diff = Math.abs(rating1 - rating2);
        
        // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
        let player1Odds, player2Odds;
        
        if (diff < 50) {
            player1Odds = 1.8;
            player2Odds = 1.9;
        } else if (diff < 100) {
            if (rating1 > rating2) {
                player1Odds = 1.6;
                player2Odds = 2.2;
            } else {
                player1Odds = 2.2;
                player2Odds = 1.6;
            }
        } else if (diff < 150) {
            if (rating1 > rating2) {
                player1Odds = 1.5;
                player2Odds = 2.5;
            } else {
                player1Odds = 2.5;
                player2Odds = 1.5;
            }
        } else {
            if (rating1 > rating2) {
                player1Odds = 1.4;
                player2Odds = 2.8;
            } else {
                player1Odds = 2.8;
                player2Odds = 1.4;
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—á –¥–ª—è —Å—Ç–∞–≤–æ–∫
        const betMatchData = {
            id: betMatchId,
            player1: tournamentMatch.player1,
            player2: tournamentMatch.player2,
            player1_rating: rating1,
            player2_rating: rating2,
            tournament_id: currentTournament.id,
            tournament_match_id: tournamentMatch.id,
            date: tournamentMatch.created_at || new Date().toISOString(),
            status: 'pending',
            odds: {
                player1: player1Odds,
                player2: player2Odds
            },
            created_at: new Date().toISOString()
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
        const { error } = await supabase
            .from('bet_matches')
            .upsert([betMatchData], { onConflict: 'id' });
        
        if (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—á–∞ –¥–ª—è —Å—Ç–∞–≤–æ–∫:', error);
            return;
        }
        
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω –º–∞—Ç—á –¥–ª—è —Å—Ç–∞–≤–æ–∫: ${tournamentMatch.player1} vs ${tournamentMatch.player2}`);
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ –Ω–æ–≤—ã—Ö —Å—Ç–∞–≤–∫–∞—Ö
        notifyPlayersAboutNewBets(betMatchData);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—á–∞ –¥–ª—è —Å—Ç–∞–≤–æ–∫:', error);
    }
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –æ –Ω–æ–≤—ã—Ö —Å—Ç–∞–≤–∫–∞—Ö
function notifyPlayersAboutNewBets(betMatch) {
    // –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    console.log(`üîî –ù–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã: ${betMatch.player1} vs ${betMatch.player2}`);
    
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
    // 1. Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    // 2. Email —Ä–∞—Å—Å—ã–ª–∫—É
    // 3. –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
}

// ============================================
// –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ê–°–ß–ï–¢ –°–¢–ê–í–û–ö –ü–†–ò –ó–ê–í–ï–†–®–ï–ù–ò–ò –ú–ê–¢–ß–ê
// ============================================
async function autoCalculateBetsForFinishedMatch(tournamentMatch) {
    if (!tournamentMatch.winner) return;
    
    try {
        console.log(`üßÆ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç —Å—Ç–∞–≤–æ–∫ –¥–ª—è –º–∞—Ç—á–∞ ${tournamentMatch.id}`);
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–∞—Ç—á –¥–ª—è —Å—Ç–∞–≤–æ–∫
        const betMatchId = `bet_${tournamentMatch.id}`;
        const { data: betMatches } = await supabase
            .from('bet_matches')
            .select('*')
            .eq('id', betMatchId);
        
        if (!betMatches || betMatches.length === 0) {
            console.log('‚ùå –ú–∞—Ç—á –¥–ª—è —Å—Ç–∞–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const betMatch = betMatches[0];
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –º–∞—Ç—á
        const { data: activeBets } = await supabase
            .from('player_bets')
            .select('*')
            .eq('match_id', betMatchId)
            .eq('status', 'active');
        
        if (!activeBets || activeBets.length === 0) {
            console.log('‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –Ω–∞ —ç—Ç–æ—Ç –º–∞—Ç—á');
            return;
        }
        
        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${activeBets.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞`);
        
        let totalWonAmount = 0;
        let winnersCount = 0;
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç–∞–≤–∫—É
        for (const bet of activeBets) {
            let betStatus = 'lost';
            let winAmount = 0;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–∏–≥—Ä–∞–ª–∞ –ª–∏ —Å—Ç–∞–≤–∫–∞
            if (bet.bet_on === tournamentMatch.winner) {
                betStatus = 'won';
                winAmount = Math.round(bet.amount * bet.odds);
                totalWonAmount += winAmount;
                winnersCount++;
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à –∏–≥—Ä–æ–∫—É
                await addTokensToPlayer(bet.player_name, winAmount);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–≤–∫–∏
            await supabase
                .from('player_bets')
                .update({
                    status: betStatus,
                    actual_win: winAmount,
                    updated_at: new Date().toISOString()
                })
                .eq('id', bet.id);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á–∞ –¥–ª—è —Å—Ç–∞–≤–æ–∫
        await supabase
            .from('bet_matches')
            .update({
                status: 'finished',
                result: tournamentMatch.winner,
                updated_at: new Date().toISOString()
            })
            .eq('id', betMatchId);
        
        console.log(`‚úÖ –†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –í—ã–∏–≥—Ä–∞–ª–æ —Å—Ç–∞–≤–æ–∫: ${winnersCount}, –û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à: ${totalWonAmount} –∂–µ—Ç–æ–Ω–æ–≤`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(`–†–∞—Å—á–µ—Ç —Å—Ç–∞–≤–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω! ${winnersCount} –∏–≥—Ä–æ–∫–æ–≤ –≤—ã–∏–≥—Ä–∞–ª–∏ ${totalWonAmount} –∂–µ—Ç–æ–Ω–æ–≤`, 'success');
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await loadAllData();
        updateBetsDisplay();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞–≤–æ–∫:', error);
        showNotification('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞–≤–æ–∫', 'error');
    }
}

// ============================================
// –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
// ============================================
function openTab(tabName) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    document.getElementById(tabName).classList.add('active');
    
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
    event.target.classList.add('active');
}

function updateTournamentDisplay() {
    const container = document.getElementById('currentTournament');
    
    if (!currentTournament) {
        container.innerHTML = '<div class="loading">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞</div>';
        return;
    }
    
    let html = `
        <div class="tournament-card">
            <h3>${currentTournament.name}</h3>
            <p>–¢–∏–ø: ${currentTournament.type_name}</p>
            <p>–°—Ç–∞—Ç—É—Å: ${currentTournament.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–≤–µ—Ä—à–µ–Ω'}</p>
            <p>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${currentTournament.players ? currentTournament.players.length : 0}</p>
            <p>–ú–∞—Ç—á–µ–π: ${tournamentMatches.length}</p>
            
            <h4>–ú–∞—Ç—á–∏ —Ç—É—Ä–Ω–∏—Ä–∞:</h4>
    `;
    
    if (tournamentMatches.length === 0) {
        html += '<p>–ú–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
    } else {
        tournamentMatches.forEach(match => {
            const winnerText = match.winner ? `üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${match.winner}` : '‚è≥ –û–∂–∏–¥–∞–µ—Ç—Å—è';
            html += `
                <div class="match-item">
                    <div>${match.player1} vs ${match.player2}</div>
                    <div>${winnerText}</div>
                    <div>
                        ${!match.winner ? 
                            `<button onclick="completeMatch('${match.id}', '${match.player1}')">–ü1</button>
                             <button onclick="completeMatch('${match.id}', '${match.player2}')">–ü2</button>` : 
                            '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω'
                        }
                    </div>
                </div>
            `;
        });
    }
    
    html += `
            <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
                <strong>üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞–≤–∫–∞–º–∏:</strong>
                <p>–°–æ–∑–¥–∞–Ω–æ —Å—Ç–∞–≤–æ–∫: ${allBets.filter(b => b.match_id.includes(currentTournament.id)).length}</p>
                <button onclick="autoCreateBetsForTournament()" style="margin-top: 10px; padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    üîÑ –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–∞—Ç—á–µ–π
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function updateBetsDisplay() {
    const activeContainer = document.getElementById('activeBets');
    const historyContainer = document.getElementById('betHistory');
    
    // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
    const activeBets = allBets.filter(bet => bet.status === 'active');
    
    if (activeBets.length === 0) {
        activeContainer.innerHTML = '<div class="loading">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</div>';
    } else {
        let html = '';
        activeBets.forEach(bet => {
            html += `
                <div class="bet-card">
                    <h4>–°—Ç–∞–≤–∫–∞ #${bet.id.slice(-6)}</h4>
                    <p>–ò–≥—Ä–æ–∫: ${bet.player_name}</p>
                    <p>–ú–∞—Ç—á: ${bet.match_id}</p>
                    <p>–°—Ç–∞–≤–∫–∞ –Ω–∞: ${bet.bet_on}</p>
                    <p>–°—É–º–º–∞: ${bet.amount} –∂–µ—Ç–æ–Ω–æ–≤</p>
                    <p>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: ${bet.odds}</p>
                    <p>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: ${Math.round(bet.amount * bet.odds)} –∂–µ—Ç–æ–Ω–æ–≤</p>
                    <p>–°—Ç–∞—Ç—É—Å: <span style="color: orange;">‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</span></p>
                </div>
            `;
        });
        activeContainer.innerHTML = html;
    }
    
    // –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫
    const finishedBets = allBets.filter(bet => bet.status !== 'active');
    
    if (finishedBets.length === 0) {
        historyContainer.innerHTML = '<div class="loading">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞–≤–æ–∫</div>';
    } else {
        let html = '';
        finishedBets.forEach(bet => {
            const statusColor = bet.status === 'won' ? 'green' : 'red';
            const statusText = bet.status === 'won' ? '‚úÖ –í—ã–∏–≥—Ä–∞–Ω–∞' : '‚ùå –ü—Ä–æ–∏–≥—Ä–∞–Ω–∞';
            
            html += `
                <div class="bet-card">
                    <h4>–°—Ç–∞–≤–∫–∞ #${bet.id.slice(-6)}</h4>
                    <p>–ò–≥—Ä–æ–∫: ${bet.player_name}</p>
                    <p>–°—Ç–∞—Ç—É—Å: <span style="color: ${statusColor};">${statusText}</span></p>
                    ${bet.actual_win > 0 ? `<p>–í—ã–∏–≥—Ä—ã—à: ${bet.actual_win} –∂–µ—Ç–æ–Ω–æ–≤</p>` : ''}
                    <p>–î–∞—Ç–∞: ${new Date(bet.created_at).toLocaleDateString()}</p>
                </div>
            `;
        });
        historyContainer.innerHTML = html;
    }
}

// ============================================
// –§–£–ù–ö–¶–ò–ò –¢–£–†–ù–ò–†–û–í
// ============================================
async function createTournament() {
    const name = document.getElementById('tournamentName').value;
    const type = document.getElementById('tournamentType').value;
    const selectedPlayers = Array.from(document.querySelectorAll('#playerSelection input:checked'))
                                .map(cb => cb.value.split(' ')[0]); // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è –∏–≥—Ä–æ–∫–∞
    
    if (!name || selectedPlayers.length < 3) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã 3 –∏–≥—Ä–æ–∫–æ–≤', 'error');
        return;
    }
    
    try {
        // –°–æ–∑–¥–∞–µ–º —Ç—É—Ä–Ω–∏—Ä
        const tournamentId = `tournament_${Date.now()}`;
        const tournamentData = {
            id: tournamentId,
            name: name,
            type: type,
            type_name: type === 'round_robin_3' ? '–ö—Ä—É–≥–æ–≤–æ–π —Ç—É—Ä–Ω–∏—Ä (3 –∏–≥—Ä–æ–∫–∞)' :
                      type === 'round_robin_4' ? '–ö—Ä—É–≥–æ–≤–æ–π —Ç—É—Ä–Ω–∏—Ä (4 –∏–≥—Ä–æ–∫–∞)' :
                      '–ö—Ä—É–≥–æ–≤–æ–π —Ç—É—Ä–Ω–∏—Ä (5 –∏–≥—Ä–æ–∫–æ–≤)',
            players: selectedPlayers,
            status: 'active',
            created_at: new Date().toISOString()
        };
        
        const { error: tournamentError } = await supabase
            .from('tournaments')
            .upsert([tournamentData], { onConflict: 'id' });
        
        if (tournamentError) throw tournamentError;
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—á–∏ –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–∞
        await createTournamentMatches(tournamentId, selectedPlayers);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç—É—Ä–Ω–∏—Ä
        currentTournament = tournamentData;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º —Å—Ç–∞–≤–∫–∏ –¥–ª—è –º–∞—Ç—á–µ–π
        await autoCreateBetsForTournament();
        
        showNotification(`–¢—É—Ä–Ω–∏—Ä "${name}" —Å–æ–∑–¥–∞–Ω! –°—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã.`, 'success');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        await loadAllData();
        updateTournamentDisplay();
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('tournamentName').value = '';
        document.querySelectorAll('#playerSelection input').forEach(cb => cb.checked = false);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞', 'error');
    }
}

async function createTournamentMatches(tournamentId, players) {
    // –°–æ–∑–¥–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ä—ã –º–∞—Ç—á–µ–π –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞
    for (let i = 0; i < players.length; i++) {
        for (let j = i + 1; j < players.length; j++) {
            const matchId = `${tournamentId}_${players[i]}_${players[j]}`;
            
            const matchData = {
                id: matchId,
                tournament_id: tournamentId,
                player1: players[i],
                player2: players[j],
                winner: null,
                status: 'scheduled',
                created_at: new Date().toISOString()
            };
            
            await supabase
                .from('tournament_matches')
                .upsert([matchData], { onConflict: 'id' });
        }
    }
}

// ============================================
// –ó–ê–í–ï–†–®–ï–ù–ò–ï –ú–ê–¢–ß–ê –ò –ê–í–¢–û–†–ê–°–ß–ï–¢ –°–¢–ê–í–û–ö
// ============================================
async function completeMatch(matchId, winner) {
    if (!confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–±–µ–¥—É ${winner}? –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –º–∞—Ç—á.`)) {
        return;
    }
    
    try {
        console.log(`üéÆ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∞—Ç—á–∞ ${matchId}, –ø–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç—á –≤ —Ç—É—Ä–Ω–∏—Ä–µ
        const { error: matchError } = await supabase
            .from('tournament_matches')
            .update({
                winner: winner,
                status: 'finished',
                updated_at: new Date().toISOString()
            })
            .eq('id', matchId);
        
        if (matchError) throw matchError;
        
        // –ù–∞—Ö–æ–¥–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞—Ç—á
        const { data: updatedMatch } = await supabase
            .from('tournament_matches')
            .select('*')
            .eq('id', matchId)
            .single();
        
        if (!updatedMatch) throw new Error('–ú–∞—Ç—á –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ê–°–ß–ï–¢ –°–¢–ê–í–û–ö
        await autoCalculateBetsForFinishedMatch(updatedMatch);
        
        showNotification(`–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner}. –°—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã.`, 'success');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        await loadAllData();
        updateTournamentDisplay();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞—Ç—á–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞—Ç—á–∞', 'error');
    }
}

// ============================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ============================================
async function addTokensToPlayer(playerName, amount) {
    try {
        // –ù–∞—Ö–æ–¥–∏–º –∫–∞–±–∏–Ω–µ—Ç –∏–≥—Ä–æ–∫–∞
        const { data: cabinet } = await supabase
            .from('player_cabinets')
            .select('*')
            .eq('player_name', playerName)
            .single();
        
        if (!cabinet) {
            // –°–æ–∑–¥–∞–µ–º –∫–∞–±–∏–Ω–µ—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const newCabinet = {
                player_name: playerName,
                login: playerName.toLowerCase().replace(/\s+/g, '_'),
                password: 'default123',
                tokens: amount,
                join_date: new Date().toISOString()
            };
            
            await supabase
                .from('player_cabinets')
                .insert([newCabinet]);
        } else {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–∞–±–∏–Ω–µ—Ç
            const newTokens = (cabinet.tokens || 0) + amount;
            
            await supabase
                .from('player_cabinets')
                .update({ tokens: newTokens })
                .eq('player_name', playerName);
        }
        
        console.log(`‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${amount} –∂–µ—Ç–æ–Ω–æ–≤ –∏–≥—Ä–æ–∫—É ${playerName}`);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∂–µ—Ç–æ–Ω–æ–≤:', error);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// ============================================
// –§–£–ù–ö–¶–ò–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –ò–ù–¢–ï–ì–†–ê–¶–ò–ò (–û–î–ò–ù –®–ê–ì)
// ============================================
async function runAutoIntegration() {
    console.log('üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...');
    
    try {
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞
        if (!currentTournament) {
            showNotification('–°–æ–∑–¥–∞–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏', 'error');
            openTab('tournaments');
            return;
        }
        
        // 2. –ù–∞—Ö–æ–¥–∏–º –º–∞—Ç—á–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —Å—Ç–∞–≤–æ–∫
        const matchesNeedingBets = tournamentMatches.filter(match => 
            !match.winner && 
            allBets.filter(b => b.match_id === `bet_${match.id}`).length === 0
        );
        
        if (matchesNeedingBets.length === 0) {
            showNotification('–í—Å–µ –º–∞—Ç—á–∏ —É–∂–µ –∏–º–µ—é—Ç —Å—Ç–∞–≤–∫–∏', 'info');
            return;
        }
        
        // 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º —Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö –º–∞—Ç—á–µ–π
        let createdCount = 0;
        for (const match of matchesNeedingBets) {
            await createBetMatchFromTournamentMatch(match);
            createdCount++;
        }
        
        // 4. –ù–∞—Ö–æ–¥–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –º–∞—Ç—á–∏ –±–µ–∑ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞–≤–æ–∫
        const finishedMatches = tournamentMatches.filter(match => 
            match.winner && 
            match.status === 'finished'
        );
        
        let calculatedCount = 0;
        for (const match of finishedMatches) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã —Å—Ç–∞–≤–∫–∏
            const betMatchId = `bet_${match.id}`;
            const betMatch = allBets.find(b => b.match_id === betMatchId);
            
            if (betMatch && betMatch.status === 'active') {
                await autoCalculateBetsForFinishedMatch(match);
                calculatedCount++;
            }
        }
        
        // 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateIntegrationStats();
        
        showNotification(`‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–æ–∑–¥–∞–Ω–æ —Å—Ç–∞–≤–æ–∫: ${createdCount}, –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ: ${calculatedCount}`, 'success');
        
        // 6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await loadAllData();
        updateTournamentDisplay();
        updateBetsDisplay();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:', error);
        showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏', 'error');
    }
}

function updateIntegrationStats() {
    // –°—á–∏—Ç–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
    const autoCreatedBets = allBets.filter(bet => 
        bet.match_id.includes('bet_') && 
        bet.match_id.includes(currentTournament?.id || '')
    ).length;
    
    // –°—á–∏—Ç–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
    const autoCalculatedBets = allBets.filter(bet => 
        bet.status !== 'active' && 
        bet.actual_win > 0
    ).length;
    
    // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–µ—Ç–æ–Ω–æ–≤
    const totalTokens = playerCabinets.reduce((sum, cabinet) => 
        sum + (cabinet.tokens || 0), 0
    );
    
    document.getElementById('autoBetsCount').textContent = autoCreatedBets;
    document.getElementById('autoCalculated').textContent = autoCalculatedBets;
    document.getElementById('totalTokens').textContent = totalTokens;
}

// ============================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
// ============================================
// –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const playerSelection = document.getElementById('playerSelection');
    const samplePlayers = [
        { name: '–ò–≥—Ä–æ–∫ 1', rating: 1000 },
        { name: '–ò–≥—Ä–æ–∫ 2', rating: 950 },
        { name: '–ò–≥—Ä–æ–∫ 3', rating: 1100 },
        { name: '–≥—Ä–æ–∫ 4', rating: 1050 },
        { name: '–ò–≥—Ä–æ–∫ 5', rating: 980 }
    ];
    
    playerSelection.innerHTML = '';
    samplePlayers.forEach(player => {
        const label = document.createElement('label');
        label.innerHTML = `
            <input type="checkbox" value="${player.name}">
            ${player.name} (${player.rating})
        `;
        playerSelection.appendChild(label);
        playerSelection.appendChild(document.createElement('br'));
    });
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
(async function() {
    console.log('üéæ –°–∏—Å—Ç–µ–º–∞ —Ç–µ–Ω–Ω–∏—Å–Ω–æ–π –ª–∏–≥–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å—Ç–∞–≤–æ–∫');
    console.log('===============================================');
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(async () => {
        await loadAllData();
        updateIntegrationStats();
    }, 1000);
})();
</script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</body>
</html>
